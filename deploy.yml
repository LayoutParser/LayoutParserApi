name: Deploy to Production Server

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'LayoutParserApi/**'
      - 'LayoutParser/**'
      - 'LayoutParserDecrypt/**'
      - 'LayoutParserLib/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Permite executar manualmente

jobs:
  deploy:
    runs-on: self-hosted  # ‚úÖ Runner instalado no servidor (172.25.32.42)
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Setup MSBuild for .NET Framework
      uses: microsoft/setup-msbuild@v1.1
      with:
        msbuild-version: 'latest'
    
    - name: Build LayoutParserLib (.NET Framework 4.8.1)
      working-directory: ./LayoutParserLib
      run: |
        msbuild LayoutParserLib.csproj /p:Configuration=Release /p:Platform=AnyCPU /t:Restore,Build /verbosity:minimal
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Falha ao compilar LayoutParserLib"
          exit 1
        }
        Write-Host "‚úÖ LayoutParserLib compilado com sucesso"
    
    - name: Build LayoutParserDecrypt (.NET Framework 4.8.1)
      working-directory: ./LayoutParserDecrypt
      run: |
        # Copiar DLL da lib para o diret√≥rio do Decrypt
        Copy-Item -Path "..\LayoutParserLib\bin\Release\LayoutParserLib.dll" -Destination "." -Force
        msbuild LayoutParserDecrypt.csproj /p:Configuration=Release /p:Platform=AnyCPU /t:Restore,Build /verbosity:minimal
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Falha ao compilar LayoutParserDecrypt"
          exit 1
        }
        Write-Host "‚úÖ LayoutParserDecrypt compilado com sucesso"
    
    - name: Build LayoutParserApi (.NET Core 9.0)
      working-directory: ./LayoutParserApi
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Falha ao compilar LayoutParserApi"
          exit 1
        }
        Write-Host "‚úÖ LayoutParserApi compilado com sucesso"
    
    - name: Publish LayoutParserApi
      working-directory: ./LayoutParserApi
      run: |
        dotnet publish --configuration Release --no-build --output ./publish
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Falha ao publicar LayoutParserApi"
          exit 1
        }
        Write-Host "‚úÖ LayoutParserApi publicado com sucesso"
    
    - name: Create deployment package
      run: |
        Write-Host "üì¶ Criando pacote de deploy..."
        
        # Criar estrutura de deploy
        New-Item -ItemType Directory -Path deploy/api -Force | Out-Null
        New-Item -ItemType Directory -Path deploy/front-end -Force | Out-Null
        
        # Copiar arquivos da API
        Write-Host "üìã Copiando arquivos da API..."
        Copy-Item -Path "LayoutParserApi/publish/*" -Destination "deploy/api/" -Recurse -Force
        
        # Copiar arquivos do front-end
        Write-Host "üìã Copiando arquivos do front-end..."
        Copy-Item -Path "LayoutParser/wwwroot/*" -Destination "deploy/front-end/" -Recurse -Force
        
        # Copiar LayoutParserDecrypt.exe e DLLs
        Write-Host "üìã Copiando LayoutParserDecrypt e depend√™ncias..."
        if (Test-Path "LayoutParserDecrypt/bin/Release/LayoutParserDecrypt.exe") {
          Copy-Item -Path "LayoutParserDecrypt/bin/Release/LayoutParserDecrypt.exe" -Destination "deploy/api/" -Force
          Write-Host "  ‚úÖ LayoutParserDecrypt.exe copiado"
        } else {
          Write-Warning "  ‚ö†Ô∏è LayoutParserDecrypt.exe n√£o encontrado em bin/Release/"
        }
        
        if (Test-Path "LayoutParserDecrypt/bin/Release/LayoutParserLib.dll") {
          Copy-Item -Path "LayoutParserDecrypt/bin/Release/LayoutParserLib.dll" -Destination "deploy/api/" -Force
          Write-Host "  ‚úÖ LayoutParserLib.dll copiado"
        } elseif (Test-Path "LayoutParserLib/bin/Release/LayoutParserLib.dll") {
          Copy-Item -Path "LayoutParserLib/bin/Release/LayoutParserLib.dll" -Destination "deploy/api/" -Force
          Write-Host "  ‚úÖ LayoutParserLib.dll copiado da lib"
        } else {
          Write-Warning "  ‚ö†Ô∏è LayoutParserLib.dll n√£o encontrado"
        }
        
        # Verificar estrutura
        Write-Host "`nüìÇ Estrutura do deploy:"
        Get-ChildItem -Path deploy -Recurse -File | Select-Object FullName | ForEach-Object { Write-Host "  $($_.FullName)" }
        
        Write-Host "`n‚úÖ Pacote de deploy criado com sucesso!"
    
    - name: Deploy to server (local)
      run: |
        $ErrorActionPreference = "Stop"
        $DEPLOY_PATH = "${{ secrets.DEPLOY_PATH }}"
        
        Write-Host "üöÄ Iniciando deploy no servidor..."
        Write-Host "üìÇ Caminho de deploy: $DEPLOY_PATH"
        Write-Host "üèÉ Runner: Self-hosted (executando localmente)"
        Write-Host "üåê Servidor: 172.25.32.42"
        
        # Criar diret√≥rios se n√£o existirem
        Write-Host "üìÅ Criando diret√≥rios..."
        New-Item -ItemType Directory -Path "$DEPLOY_PATH/api" -Force | Out-Null
        New-Item -ItemType Directory -Path "$DEPLOY_PATH/front-end" -Force | Out-Null
        New-Item -ItemType Directory -Path "$DEPLOY_PATH/api/Logs" -Force | Out-Null
        New-Item -ItemType Directory -Path "$DEPLOY_PATH/backups" -Force | Out-Null
        
        # Backup do appsettings.json se existir
        if (Test-Path "$DEPLOY_PATH/api/appsettings.json") {
          $backupName = "appsettings-$(Get-Date -Format 'yyyyMMdd-HHmmss').json"
          Write-Host "üíæ Fazendo backup do appsettings.json: $backupName"
          Copy-Item -Path "$DEPLOY_PATH/api/appsettings.json" -Destination "$DEPLOY_PATH/backups/$backupName" -Force
        }
        
        # Parar servi√ßo Windows se existir
        $serviceName = "LayoutParserApi"
        if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
          Write-Host "‚è∏Ô∏è Parando servi√ßo $serviceName..."
          Stop-Service -Name $serviceName -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
        }
        
        # Copiar arquivos da API (manter appsettings.json se j√° existir)
        Write-Host "üìã Copiando arquivos da API..."
        Get-ChildItem -Path "deploy/api" -Exclude "appsettings.json" | Copy-Item -Destination "$DEPLOY_PATH/api/" -Recurse -Force
        Write-Host "  ‚úÖ Arquivos da API copiados"
        
        # Copiar arquivos do front-end
        Write-Host "üìã Copiando arquivos do front-end..."
        Copy-Item -Path "deploy/front-end/*" -Destination "$DEPLOY_PATH/front-end/" -Recurse -Force
        Write-Host "  ‚úÖ Arquivos do front-end copiados"
        
        # Verificar se LayoutParserDecrypt.exe foi copiado
        if (Test-Path "$DEPLOY_PATH/api/LayoutParserDecrypt.exe") {
          Write-Host "  ‚úÖ LayoutParserDecrypt.exe encontrado"
        } else {
          Write-Warning "  ‚ö†Ô∏è LayoutParserDecrypt.exe n√£o encontrado ap√≥s deploy"
        }
        
        # Verificar se LayoutParserLib.dll foi copiado
        if (Test-Path "$DEPLOY_PATH/api/LayoutParserLib.dll") {
          Write-Host "  ‚úÖ LayoutParserLib.dll encontrado"
        } else {
          Write-Warning "  ‚ö†Ô∏è LayoutParserLib.dll n√£o encontrado ap√≥s deploy"
        }
        
        # Reiniciar servi√ßo Windows se existir
        if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
          Write-Host "‚ñ∂Ô∏è Reiniciando servi√ßo $serviceName..."
          Start-Service -Name $serviceName -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          
          $service = Get-Service -Name $serviceName
          if ($service.Status -eq 'Running') {
            Write-Host "  ‚úÖ Servi√ßo $serviceName est√° em execu√ß√£o"
          } else {
            Write-Warning "  ‚ö†Ô∏è Servi√ßo $serviceName n√£o est√° em execu√ß√£o (Status: $($service.Status))"
          }
        } else {
          Write-Host "‚ÑπÔ∏è Servi√ßo $serviceName n√£o encontrado. Execute manualmente:"
          Write-Host "   cd $DEPLOY_PATH/api"
          Write-Host "   dotnet LayoutParserApi.dll"
        }
        
        # Validar deploy
        Write-Host "`n‚úÖ Deploy conclu√≠do com sucesso!"
        Write-Host "üìç API: $DEPLOY_PATH/api"
        Write-Host "üìç Front-end: $DEPLOY_PATH/front-end"
        Write-Host "üìç Logs: $DEPLOY_PATH/api/Logs"
        Write-Host "üèÉ Runner: Self-hosted (execu√ß√£o local)"
